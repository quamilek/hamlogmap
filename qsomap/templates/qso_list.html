<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QSO List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- <script src="https://unpkg.com/leaflet-arc@1.0.0/dist/leaflet-arc.js"></script> -->
    <script src='//unpkg.com/leaflet-arc/bin/leaflet-arc.min.js'></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #map { 
            height: 100vh;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .content-container {
            position: relative;
            z-index: 2;
            background: rgba(255, 255, 255, 0.9);
            margin: 20px;
            margin-top: 80px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .small-marker {
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            border: 1px solid black;
        }
        .my-marker {
            width: 10px;
            height: 10px;
            background-color: green;
            border-radius: 50%;
            border: 1px solid black;
        }
        .table-container {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="top-bar">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0">QSO List</h1>
            <div>
                <button id="show-stats-button" class="btn btn-primary me-2">Show Statistics</button>
                <button id="night-mode-button" class="btn btn-dark">Toggle Night Mode</button>
            </div>
        </div>
    </div>
    <div class="content-container" style="display: none;">
        <div class="data-container">
            <div class="stats-container mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="card-title">DXCC Statistics</h5>
                                <p class="card-text">Total DXCC entities: <span id="dxcc-count">0</span></p>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>DXCC</th>
                                                <th>Total QSOs</th>
                                                <th>Mode Breakdown</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dxcc-list">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5 class="card-title">Band Statistics</h5>
                                <p class="card-text">Total Bands: <span id="band-count">0</span></p>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>Band</th>
                                                <th>QSOs</th>
                                            </tr>
                                        </thead>
                                        <tbody id="band-list">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="table-container">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Call</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Band</th>
                            <th>Mode</th>
                            <th>Grid</th>
                            <th>DXCC</th>
                            <th>Latitude</th>
                            <th>Longitude</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for qso in qsos %}
                        <tr>
                            <td>{{ qso.call }}</td>
                            <td>{{ qso.date }}</td>
                            <td>{{ qso.time }}</td>
                            <td>{{ qso.band }}</td>
                            <td>{{ qso.mode }}</td>
                            <td>{{ qso.grid }}</td>
                            <td>{{ qso.dxcc }}</td>
                            <td>{{ qso.latitude }}</td>
                            <td>{{ qso.longitude }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        var map = L.map('map').setView([0, 0], 2);
        var dayLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        var nightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap contributors'
        });

        var qsos = {{ qsos|tojson }};
        
        // Calculate DXCC statistics
        const dxccCount = new Set(qsos.map(qso => qso.dxcc)).size;
        document.getElementById('dxcc-count').textContent = dxccCount;
        
        // Create DXCC list with mode breakdown
        const dxccList = qsos.reduce((acc, qso) => {
            if (!acc[qso.dxcc]) {
                acc[qso.dxcc] = {
                    total: 0,
                    modes: {}
                };
            }
            acc[qso.dxcc].total++;
            if (!acc[qso.dxcc].modes[qso.mode]) {
                acc[qso.dxcc].modes[qso.mode] = 0;
            }
            acc[qso.dxcc].modes[qso.mode]++;
            return acc;
        }, {});
        
        const dxccListElement = document.getElementById('dxcc-list');
        Object.entries(dxccList)
            .sort((a, b) => b[1].total - a[1].total)
            .forEach(([dxcc, data]) => {
                const modeBreakdown = Object.entries(data.modes)
                    .sort((a, b) => b[1] - a[1])
                    .map(([mode, count]) => `${mode}: ${count}`)
                    .join('<br>');
                
                dxccListElement.innerHTML += `
                    <tr>
                        <td>${dxcc}</td>
                        <td>${data.total}</td>
                        <td>${modeBreakdown}</td>
                    </tr>`;
            });

        // Calculate Band statistics
        const bandCount = new Set(qsos.map(qso => qso.band)).size;
        document.getElementById('band-count').textContent = bandCount;
        
        // Create Band list
        const bandList = qsos.reduce((acc, qso) => {
            if (!acc[qso.band]) {
                acc[qso.band] = 0;
            }
            acc[qso.band]++;
            return acc;
        }, {});
        
        const bandListElement = document.getElementById('band-list');
        Object.entries(bandList)
            .sort((a, b) => b[1] - a[1])
            .forEach(([band, count]) => {
                bandListElement.innerHTML += `
                    <tr>
                        <td>${band}</td>
                        <td>${count}</td>
                    </tr>`;
            });

        qsos.forEach(function(qso) {
            var marker = L.marker([qso.latitude, qso.longitude], {
                icon: L.divIcon({
                    className: 'small-marker',
                    iconSize: [7, 7]
                })
            }).addTo(map);
            marker.bindPopup(`
                <strong>Call:</strong> ${qso.call}<br>
                <strong>Date:</strong> ${qso.date}<br>
                <strong>Time:</strong> ${qso.time}<br>
                <strong>Mode:</strong> ${qso.mode}<br>
                <strong>Grid:</strong> ${qso.grid}<br>
                <strong>DXCC:</strong> ${qso.dxcc}
            `);
        });

        var myMarker = L.marker([{{ my_latitude }}, {{ my_longitude }}], {
            icon: L.divIcon({
                className: 'my-marker',
                iconSize: [5, 5]
            })
        }).addTo(map);
        myMarker.bindPopup('<strong>My Location</strong>');

        qsos.forEach(function(qso) {
            console.log([qso.latitude, qso.longitude]);
            // if (qso.latitude != Nan || qso.longitude != Nan) {
            try {
                L.Polyline.Arc([{{ my_latitude }}, {{ my_longitude }}], [qso.latitude, qso.longitude], {
                    color: 'red',
                    weight: 2,
                    opacity: 0.5,
                    vertices: 200
                }).addTo(map);
            } catch (e) {
                console.log(e);
            }
            // }
            // L.Polyline.Arc([43.11667, 131.90000], [55.7522200, 37.6155600]).addTo(map);
        });

        document.getElementById('night-mode-button').addEventListener('click', function() {
            if (map.hasLayer(dayLayer)) {
                map.removeLayer(dayLayer);
                map.addLayer(nightLayer);
            } else {
                map.removeLayer(nightLayer);
                map.addLayer(dayLayer);
            }
        });

        // Add stats toggle functionality
        const contentContainer = document.querySelector('.content-container');
        const showStatsButton = document.getElementById('show-stats-button');
        showStatsButton.addEventListener('click', function() {
            if (contentContainer.style.display === 'none') {
                contentContainer.style.display = 'block';
                showStatsButton.textContent = 'Hide Statistics';
            } else {
                contentContainer.style.display = 'none';
                showStatsButton.textContent = 'Show Statistics';
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 