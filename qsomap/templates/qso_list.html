<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QSO Map</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src='//unpkg.com/leaflet-arc/bin/leaflet-arc.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-image@0.4.0/leaflet-image.min.js"></script>
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #map { 
            flex: 1;
            width: 100%;
            position: relative;
            z-index: 1;
            margin-top: 60px;
        }
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            height: 60px;
        }
        .top-bar-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
        }
        .top-bar-title {
            margin: 0;
            padding: 0;
        }
        .top-bar-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .content-container {
            position: relative;
            z-index: 2;
            background: rgba(255, 255, 255, 0.9);
            margin: 20px;
            margin-top: 80px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .small-marker {
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            border: 1px solid black;
        }
        .my-marker {
            width: 10px;
            height: 10px;
            background-color: green;
            border-radius: 50%;
            border: 1px solid black;
        }
        .table-container {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .mode-cell {
            display: inline-block;
            padding: 2px 5px;
            border-radius: 3px;
            color: white;
            font-weight: bold;
        }
        .mode-filter-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            width: 280px;
        }
        .mode-filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 5px;
        }
        .mode-filter-content {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .mode-checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .mode-checkbox-item label {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
        }
        .mode-color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        /* Tablet and Mobile styles */
        @media (max-width: 1024px) {
            .top-bar {
                padding: 8px 15px;
                height: auto;
                min-height: 60px;
            }
            .top-bar-content {
                flex-direction: column;
                gap: 8px;
            }
            .top-bar-title {
                text-align: center;
                font-size: 1.2rem;
                margin-bottom: 5px;
            }
            .top-bar-controls {
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
            }
            .top-bar-controls .btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.9rem;
                white-space: nowrap;
            }
            .form-check {
                margin: 0;
                padding: 0;
            }
            .form-check-label {
                font-size: 0.9rem;
            }
            #map {
                margin-top: 80px;
            }
        }

        /* Mobile specific styles */
        @media (max-width: 768px) {
            .top-bar {
                padding: 5px 10px;
            }
            .top-bar-content {
                gap: 5px;
            }
            .top-bar-title {
                font-size: 1.1rem;
            }
            .top-bar-controls {
                gap: 5px;
            }
            .top-bar-controls .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.8rem;
            }
            .form-check-label {
                font-size: 0.8rem;
            }
            #map {
                margin-top: 75px;
            }
            .mode-filter-panel {
                position: fixed;
                bottom: 20px;
                right: 20px;
                left: 20px;
                top: auto;
                width: auto;
                max-height: 40vh;
                margin: 0;
            }
            .mode-filter-header {
                flex-direction: column;
                align-items: stretch;
            }
            .mode-filter-header h5 {
                margin: 0;
                text-align: center;
            }
            .mode-filter-header .btn-group {
                display: flex;
                justify-content: center;
                gap: 5px;
            }
            .mode-checkbox-item label {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="top-bar">
        <div class="top-bar-content">
            <h2 class="top-bar-title">QSO map - {{ callsign }} - {{ filename }}</h2>
            <div class="top-bar-controls">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="uniform-color-checkbox">
                    <label class="form-check-label" for="uniform-color-checkbox">Color Pins Band</label>
                </div>
                <button id="show-stats-button" class="btn btn-primary">Show Statistics</button>
                <button id="night-mode-button" class="btn btn-dark">Toggle Night Mode</button>
            </div>
        </div>
    </div>

    <!-- Add Mode Filter Panel -->
    <div id="mode-filter" class="mode-filter-panel">
        <div class="mode-filter-header">
            <h5>Mode Filter</h5>
            <button class="btn btn-sm btn-outline-secondary" id="toggle-all-modes">Select All</button>
        </div>
        <div class="mode-filter-content" id="mode-checkboxes">
            <!-- Checkboxes will be added here dynamically -->
        </div>
    </div>

    <div class="content-container" style="display: none;">
        <div class="data-container">
            <div class="stats-container mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="card-title">DXCC Statistics</h5>
                                <p class="card-text">Total DXCC entities: <span id="dxcc-count">0</span></p>
                                <p class="card-text">Total QSOs: <span id="total-qso-count">0</span></p>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>DXCC</th>
                                                <th>Total QSOs</th>
                                                <th>Mode Breakdown</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dxcc-list">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5 class="card-title">Band Statistics</h5>
                                <p class="card-text">Total Bands: <span id="band-count">0</span></p>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>Band</th>
                                                <th>QSOs</th>
                                                <th>Percentage</th>
                                            </tr>
                                        </thead>
                                        <tbody id="band-list">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="table-container">
                <h5>Total QSOs: <span id="total-qso-count">0</span></h5>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Call</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Band</th>
                            <th>Mode</th>
                            <th>Grid</th>
                            <th>DXCC</th>
                            <th>Latitude</th>
                            <th>Longitude</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for qso in qsos %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ qso.call }}</td>
                            <td>{{ qso.date }}</td>
                            <td>{{ qso.time }}</td>
                            <td>{{ qso.band }}</td>
                            <td>
                                <div class="mode-cell" data-mode="{{ qso.mode }}">{{ qso.mode }}</div>
                            </td>
                            <td>{{ qso.grid }}</td>
                            <td>{{ qso.dxcc }}</td>
                            <td>{{ qso.latitude }}</td>
                            <td>{{ qso.longitude }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        var map = L.map('map', {
            minZoom: 2,
            maxZoom: 18,
            worldCopyJump: true,
            maxBounds: [
                [-90, -180],
                [90, 180]
            ],
            maxBoundsViscosity: 1.0,
            crs: L.CRS.EPSG3857
        }).setView([{{ my_latitude }}, {{ my_longitude }}], 2);

        var dayLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            noWrap: false,
            continuousWorld: true,
            tileSize: 256,
            zoomOffset: 0,
            maxZoom: 19,
            maxNativeZoom: 19,
            bounds: [[-90, -180], [90, 180]],
            tms: false
        }).addTo(map);

        var nightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap contributors',
            noWrap: false,
            continuousWorld: true,
            tileSize: 256,
            zoomOffset: 0,
            maxZoom: 19,
            maxNativeZoom: 19,
            bounds: [[-90, -180], [90, 180]],
            tms: false
        });

        var qsos = {{ qsos|tojson }};
        
        // Set total QSO count
        document.getElementById('total-qso-count').textContent = qsos.length;
        
        // Calculate DXCC statistics
        const dxccCount = new Set(qsos.map(qso => qso.dxcc)).size;
        document.getElementById('dxcc-count').textContent = dxccCount;
        
        // Add markers to the map
        addMarkers();
        
        // Create DXCC list with mode breakdown
        const dxccList = qsos.reduce((acc, qso) => {
            if (!acc[qso.dxcc]) {
                acc[qso.dxcc] = {
                    total: 0,
                    modes: {}
                };
            }
            acc[qso.dxcc].total++;
            if (!acc[qso.dxcc].modes[qso.mode]) {
                acc[qso.dxcc].modes[qso.mode] = 0;
            }
            acc[qso.dxcc].modes[qso.mode]++;
            return acc;
        }, {});
        
        const dxccListElement = document.getElementById('dxcc-list');
        Object.entries(dxccList)
            .sort((a, b) => b[1].total - a[1].total)
            .forEach(([dxcc, data]) => {
                const modeBreakdown = Object.entries(data.modes)
                    .sort((a, b) => {
                        // Custom sorting order
                        const order = {
                            'CW': 1,
                            'SSB': 2,
                            'FT8': 3,
                            'FT4': 4
                        };
                        const orderA = order[a[0]] || 999;  // Default high number for other modes
                        const orderB = order[b[0]] || 999;
                        
                        if (orderA !== orderB) {
                            return orderA - orderB;
                        }
                        // If both are in the same category, sort alphabetically
                        return a[0].localeCompare(b[0]);
                    })
                    .map(([mode, count]) => {
                        const modeColor = getModeColor(mode);
                        return `<div style="background-color: ${modeColor}; color: white; padding: 2px 5px; border-radius: 3px; margin: 2px; display: inline-block;">${mode}: ${count}</div>`;
                    })
                    .join('');
                
                dxccListElement.innerHTML += `
                    <tr>
                        <td>${dxcc}</td>
                        <td>${data.total}</td>
                        <td><div style="display: flex; flex-wrap: wrap; gap: 5px;">${modeBreakdown}</div></td>
                    </tr>`;
            });

        // Calculate Band statistics
        const bandCount = new Set(qsos.map(qso => qso.band)).size;
        document.getElementById('band-count').textContent = bandCount;
        
        // Create Band list
        const bandList = qsos.reduce((acc, qso) => {
            if (!acc[qso.band]) {
                acc[qso.band] = 0;
            }
            acc[qso.band]++;
            return acc;
        }, {});
        
        const bandListElement = document.getElementById('band-list');
        Object.entries(bandList)
            .sort((a, b) => b[1] - a[1])
            .forEach(([band, count]) => {
                const color = getBandColor(band);
                bandListElement.innerHTML += `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 20px; height: 20px; border-radius: 50%; background-color: ${color}; border: 1px solid #ccc;"></div>
                                ${band}
                            </div>
                        </td>
                        <td>${count}</td>
                        <td>${((count / qsos.length) * 100).toFixed(1)}%</td>
                    </tr>`;
            });

        function getBandColor(band) {
            const bandColors = {
                '2200m': '#ff4500',  // Orange Red
                '600m': '#1e90ff',   // Dodger Blue
                '160m': '#7cfc00',   // Lawn Green
                '80m': '#e550e5',    // Purple
                '60m': '#00008b',    // Dark Blue
                '40m': '#5959ff',    // Blue
                '30m': '#62d962',    // Light Green
                '20m': '#f2c40c',    // Yellow
                '17m': '#f2f261',    // Light Yellow
                '15m': '#cca166',    // Tan
                '12m': '#b22222',    // Firebrick
                '10m': '#ff69b4',    // Hot Pink
                '6m': '#FF0000',     // Red
                '4m': '#cc0044',     // Deep Red
                '2m': '#FF1493',     // Deep Pink
                '70cm': '#999900',   // Olive
                '23cm': '#5AB8C7',   // Turquoise
                '13cm': '#A52A2A',   // Brown
                '3cm': '#808080',    // Gray
                '1.25cm': '#000000', // Black
                '2.4ghz': '#FF7F50', // Coral
                '10ghz': '#696969',  // Dim Gray
                'invalid': '#808080' // Gray
            };
            return bandColors[band] || '#808080';  // Default to gray if band not found
        }

        function getModeColor(mode) {
            const modeColors = {
                'SSB': '#FF6B6B',    // Coral Red
                'CW': '#4ECDC4',     // Turquoise
                'FT8': '#45B7D1',    // Sky Blue
                'FT4': '#96CEB4',    // Sage Green
                'RTTY': '#FFEEAD',   // Cream
                'PSK': '#D4A5A5',    // Dusty Rose
                'DIGI': '#9B59B6',   // Purple
                'FM': '#3498DB',     // Blue
                'AM': '#E67E22',     // Orange
                'DIG': '#2ECC71',    // Emerald
                'DATA': '#F1C40F',   // Yellow
                'MFSK': '#1ABC9C',   // Green Sea
                'JT65': '#34495E',   // Dark Blue
                'JT9': '#16A085',    // Dark Cyan
                'MSK144': '#8E44AD', // Purple
                'OLIVIA': '#27AE60', // Green
                'DOMINO': '#D35400', // Dark Orange
                'HELL': '#2980B9',   // Blue
                'MT63': '#C0392B',   // Red
                'SSTV': '#7F8C8D'    // Gray
            };
            return modeColors[mode] || '#95A5A6';  // Default to light gray if mode not found
        }

        function drawArc(start, end) {
            // Convert to radians
            const startLat = start[0] * Math.PI / 180;
            const startLng = start[1] * Math.PI / 180;
            const endLat = end[0] * Math.PI / 180;
            const endLng = end[1] * Math.PI / 180;

            // Calculate great circle distance
            const d = 2 * Math.asin(Math.sqrt(
                Math.pow(Math.sin((endLat - startLat) / 2), 2) +
                Math.cos(startLat) * Math.cos(endLat) * Math.pow(Math.sin((endLng - startLng) / 2), 2)
            ));

            // Calculate points along the great circle
            const points = [];
            const steps = 100;
            for (let i = 0; i <= steps; i++) {
                const t = i / steps;
                
                // Calculate intermediate point using great circle formula
                const A = Math.sin((1 - t) * d) / Math.sin(d);
                const B = Math.sin(t * d) / Math.sin(d);
                const x = A * Math.cos(startLat) * Math.cos(startLng) + B * Math.cos(endLat) * Math.cos(endLng);
                const y = A * Math.cos(startLat) * Math.sin(startLng) + B * Math.cos(endLat) * Math.sin(endLng);
                const z = A * Math.sin(startLat) + B * Math.sin(endLat);
                
                let lat = Math.atan2(z, Math.sqrt(x * x + y * y)) * 180 / Math.PI;
                let lng = Math.atan2(y, x) * 180 / Math.PI;

                // Adjust longitude to ensure we take the shortest path
                const centerLng = {{ my_longitude }};
                while (lng - centerLng > 180) lng -= 360;
                while (lng - centerLng < -180) lng += 360;
                
                points.push([lat, lng]);
            }

            // Create the polyline
            return L.polyline(points, {
                color: 'red',
                weight: 2,
                opacity: 0.5
            });
        }

        function adjustLongitude(lng, centerLng) {
            while (lng - centerLng > 180) lng -= 360;
            while (lng - centerLng < -180) lng += 360;
            return lng;
        }

        function addMarkers() {
            const centerLng = {{ my_longitude }};
            qsos.forEach(qso => {
                // Adjust longitude of the marker to match the arc
                const adjustedLng = adjustLongitude(qso.longitude, centerLng);
                
                const marker = L.circleMarker([qso.latitude, adjustedLng], {
                    radius: 3,
                    fillColor: document.getElementById('uniform-color-checkbox').checked ? getBandColor(qso.band) : '#FF0000',
                    color: '#000',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                marker.bindPopup(`
                    <strong>${qso.call}</strong><br>
                    Date: ${qso.date}<br>
                    Time: ${qso.time}<br>
                    Mode: ${qso.mode}<br>
                    Band: ${qso.band}<br>
                    Grid: ${qso.grid}<br>
                    DXCC: ${qso.dxcc}
                `);
                
                marker.addTo(map);

                // Draw arc using our custom function
                try {
                    const arc = drawArc(
                        [{{ my_latitude }}, {{ my_longitude }}],
                        [qso.latitude, adjustedLng]
                    );
                    arc.addTo(map);
                } catch (e) {
                    console.log(e);
                }
            });
        }

        var myMarker = L.marker([{{ my_latitude }}, {{ my_longitude }}], {
            icon: L.divIcon({
                className: 'my-marker',
                iconSize: [5, 5]
            })
        }).addTo(map);
        myMarker.bindPopup('<strong>My Location</strong>');

        document.getElementById('night-mode-button').addEventListener('click', function() {
            if (map.hasLayer(dayLayer)) {
                map.removeLayer(dayLayer);
                map.addLayer(nightLayer);
            } else {
                map.removeLayer(nightLayer);
                map.addLayer(dayLayer);
            }
        });

        // Add stats toggle functionality
        const contentContainer = document.querySelector('.content-container');
        const showStatsButton = document.getElementById('show-stats-button');
        showStatsButton.addEventListener('click', function() {
            if (contentContainer.style.display === 'none') {
                contentContainer.style.display = 'block';
                showStatsButton.textContent = 'Hide Statistics';
            } else {
                contentContainer.style.display = 'none';
                showStatsButton.textContent = 'Show Statistics';
            }
        });

        // Add uniform color toggle functionality
        document.getElementById('uniform-color-checkbox').addEventListener('change', function() {
            // Remove all existing markers
            map.eachLayer((layer) => {
                if (layer instanceof L.CircleMarker) {
                    map.removeLayer(layer);
                }
            });
            // Add markers again with new color setting
            addMarkers();
        });

        // Add mode filter functionality
        function initializeModeFilter() {
            const modeFilter = document.getElementById('mode-checkboxes');
            const modes = [...new Set(qsos.map(qso => qso.mode))];
            
            // Sort modes with custom order
            const modeOrder = {
                'CW': 1,
                'SSB': 2,
                'FT8': 3,
                'FT4': 4
            };
            
            modes.sort((a, b) => {
                const orderA = modeOrder[a] || 999;
                const orderB = modeOrder[b] || 999;
                if (orderA !== orderB) {
                    return orderA - orderB;
                }
                return a.localeCompare(b);
            });

            modes.forEach(mode => {
                const modeColor = getModeColor(mode);
                const div = document.createElement('div');
                div.className = 'mode-checkbox-item';
                div.innerHTML = `
                    <label>
                        <input type="checkbox" class="mode-checkbox" value="${mode}" checked>
                        <span class="mode-color-dot" style="background-color: ${modeColor}"></span>
                        ${mode}
                    </label>
                `;
                modeFilter.appendChild(div);
            });

            // Add event listeners for checkboxes
            document.querySelectorAll('.mode-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateMarkers);
            });

            // Add event listener for toggle button
            const toggleButton = document.getElementById('toggle-all-modes');
            let allSelected = true; // Initial state since all checkboxes are checked by default

            toggleButton.addEventListener('click', () => {
                const checkboxes = document.querySelectorAll('.mode-checkbox');
                allSelected = !allSelected;
                
                checkboxes.forEach(cb => cb.checked = allSelected);
                toggleButton.textContent = allSelected ? 'Deselect All' : 'Select All';
                updateMarkers();
            });
        }

        function updateMarkers() {
            // Remove all existing markers and arcs
            map.eachLayer((layer) => {
                if (layer instanceof L.CircleMarker || layer instanceof L.Polyline) {
                    map.removeLayer(layer);
                }
            });

            // Get selected modes
            const selectedModes = Array.from(document.querySelectorAll('.mode-checkbox:checked'))
                .map(cb => cb.value);

            const centerLng = {{ my_longitude }};
            // Add markers and arcs only for selected modes
            qsos.forEach(qso => {
                if (selectedModes.includes(qso.mode)) {
                    // Adjust longitude of the marker to match the arc
                    const adjustedLng = adjustLongitude(qso.longitude, centerLng);
                    
                    // Add marker
                    const marker = L.circleMarker([qso.latitude, adjustedLng], {
                        radius: 3,
                        fillColor: document.getElementById('uniform-color-checkbox').checked ? getBandColor(qso.band) : '#FF0000',
                        color: '#000',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                    
                    marker.bindPopup(`
                        <strong>${qso.call}</strong><br>
                        Date: ${qso.date}<br>
                        Time: ${qso.time}<br>
                        Mode: ${qso.mode}<br>
                        Band: ${qso.band}<br>
                        Grid: ${qso.grid}<br>
                        DXCC: ${qso.dxcc}
                    `);
                    
                    marker.addTo(map);

                    // Draw arc using our custom function
                    try {
                        const arc = drawArc(
                            [{{ my_latitude }}, {{ my_longitude }}],
                            [qso.latitude, adjustedLng]
                        );
                        arc.addTo(map);
                    } catch (e) {
                        console.log(e);
                    }
                }
            });
        }

        // Initialize mode filter after map is loaded
        initializeModeFilter();
        
        // Update markers when uniform color checkbox changes
        document.getElementById('uniform-color-checkbox').addEventListener('change', updateMarkers);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 